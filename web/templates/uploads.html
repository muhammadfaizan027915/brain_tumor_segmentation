{% extends "base.html" %}
{% block content %}


<div class="card main-card p-5 mx-auto upload-card">

    <h5 class="text-center mb-2 txt-color">Upload Your Scans</h5>
    <p class="text-center text-muted txt-size">Upload your MRI scans for tumor segmentation</p>

    <form method="post" action="{{ url_for('Uploads.upload_file') }}?session_id={{ session_id }}"
        enctype="multipart/form-data">
        <div class="upload-box mx-auto" id="drop-area">
            <i class="fa fa-upload upload-icon"></i>

            <p class="choose-text">Choose file or drag and drop it here!</p>
            <p class="meta-text">NIfTI, NII, PNG, JPG â€” max 600MB</p>

            <label class="browse-link">
                Browse
                <input type="file" name="files" id="file-input" multiple hidden>
            </label>
        </div>

        <div class="row mt-4 preview-row justify-content-center" id="preview-row"></div>

        <button class="submit-btn mt-4 mx-auto d-block upload-btn" id="submit-scan" disabled>Upload</button>
    </form>
</div>

<script>
    const fileInput = document.getElementById("file-input");
    const dropArea = document.getElementById("drop-area");
    const previewRow = document.getElementById("preview-row");
    const submitBtn = document.getElementById("submit-scan")

    fileInput.addEventListener("change", e => {
        const files = e.target.files;

        if (files.length > 0) {
            handleFiles(files);
            submitBtn.removeAttribute("disabled");
        }
    });


    dropArea.addEventListener("dragover", e => { e.preventDefault(); dropArea.classList.add("drag-hover"); });
    dropArea.addEventListener("dragleave", () => dropArea.classList.remove("drag-hover"));
    dropArea.addEventListener("drop", e => {
        e.preventDefault();
        dropArea.classList.remove("drag-hover");
        showPreview(e.dataTransfer.files[0]);
    });

    function handleFiles(files) {
        previewRow.innerHTML = "";

        Array.from(files).forEach(file => {
            showPreview(file);
        });
    }


    function showPreview(file) {
        const fileName = file.name.toLowerCase();
        const isImage = file.type.startsWith("image/");
        const isNifti = fileName.endsWith(".nii") || fileName.endsWith(".nii.gz");

        let previewHTML = `
        <div class="col-md-4 text-center mb-2">
    `;

        if (isImage) {
            const url = URL.createObjectURL(file);
            previewHTML += `<img src="${url}" class="preview-img">`;
        }

        else if (isNifti) {
            previewHTML += `
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16c0 
                1.1.9 2 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <text x="7" y="17" font-size="8" font-family="monospace">NII</text>
            </svg>
        `;
        }

        else {
            previewHTML += `
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round"
                 stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16c0 
                1.1.9 2 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
            </svg>
        `;
        }

        previewHTML += `
            <p class="small mt-1">${file.name}</p>
        </div>
    `;

        previewRow.innerHTML += previewHTML;
    }
</script>

{% endblock %}